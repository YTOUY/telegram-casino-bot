# Реализация пополнения через TON Connect

## Что было реализовано:

### 1. Backend API Endpoints

#### POST `/api/wallet/deposit-address`
- Создает запись о депозите со статусом `pending`
- Возвращает адрес TON кошелька, deposit_id и memo (user_id)
- Проверяет минимальную (0.01 TON) и максимальную сумму депозита

#### GET `/api/wallet/deposit-status/{deposit_id}`
- Проверяет статус депозита
- Автоматически проверяет транзакции в блокчейне TON
- Начисляет баланс при обнаружении транзакции с правильным memo

### 2. Frontend TON Connect Integration

- Инициализация TON Connect UI с правильным manifest
- Создание транзакций с комментарием (memo) содержащим user_id
- Обработка подключения кошелька
- Автоматическая проверка статуса депозита после отправки транзакции

### 3. Файлы

- `mini_app/tonconnect-manifest.json` - манифест для TON Connect
- Обновлен `api_server.py` - добавлены endpoints для депозита
- Обновлен `database.py` - метод `add_deposit_with_status` теперь возвращает ID
- Обновлен `mini_app/app.js` - улучшена интеграция TON Connect

## Как это работает:

1. Пользователь нажимает "Пополнить" → выбирает TON
2. Вводит сумму пополнения
3. Frontend запрашивает `/api/wallet/deposit-address` с суммой
4. Backend создает запись о депозите и возвращает адрес + deposit_id
5. Frontend инициализирует TON Connect и создает транзакцию с:
   - Адресом получателя (TON_ADDRESS из config)
   - Суммой в нанотонах
   - Payload с текстовым комментарием (user_id)
6. Пользователь подтверждает транзакцию в кошельке
7. Frontend начинает проверять статус депозита через `/api/wallet/deposit-status/{deposit_id}`
8. Backend проверяет транзакции в блокчейне и при обнаружении:
   - Начисляет баланс пользователю
   - Обновляет статус депозита на `completed`
   - Сохраняет tx_hash для защиты от дублей

## Формат комментария (memo):

Комментарий создается в формате TON text comment:
- Первые 4 байта: `0x00000000` (флаг текстового комментария)
- Следующие 4 байта: длина текста (little-endian uint32)
- Остальные байты: UTF-8 текст (user_id)

## Автоматическая проверка транзакций:

Backend использует `ton_chain.py` для проверки входящих транзакций:
- Ищет транзакции на адрес `TON_ADDRESS`
- Проверяет комментарий (memo) на совпадение с user_id
- Проверяет сумму (допускается 2% расхождение)
- Защита от дублей через таблицу `chain_payments`

## Настройки:

В `config.py`:
- `TON_ADDRESS` - адрес для приема депозитов
- `TONCENTER_API_KEY` - ключ API для проверки транзакций
- `MAX_DEPOSIT` - максимальная сумма депозита в USD
